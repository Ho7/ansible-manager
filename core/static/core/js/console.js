// Generated by CoffeeScript 1.11.1
(function() {
  var formatOutput, scrollConsole, scrolling, setLogs;

  scrolling = true;

  scrollConsole = function() {
    var console, logs;
    if (scrolling) {
      console = $('.console');
      logs = $('.logs');
      return console.animate({
        scrollTop: logs.height()
      }, 0);
    }
  };

  scrollConsole();

  setLogs = function(logs) {
    var j, len, log, message, ref, results;
    results = [];
    for (j = 0, len = logs.length; j < len; j++) {
      log = logs[j];
      message = formatOutput(log.output || log.message);
      $('.logs').append("<p class='line log-" + log.status + "'>" + message + "</p>");
      scrollConsole();
      if ((ref = log.status) === 'fail' || ref === 'stopped' || ref === 'completed') {
        this.task_running = false;
        $('#stop').hide();
        results.push($('#replay').show());
      } else {
        results.push(void 0);
      }
    }
    return results;
  };

  this.getLogs = function(last_id) {
    var url;
    if (!task_running) {
      return;
    }
    url = GET_LOGS_URL;
    if (!last_id && last_log_id) {
      last_id = last_log_id;
    }
    if (last_id) {
      url = url + "?last_log_id=" + last_id;
    }
    return $.get(url, function(data) {
      if (data.length > 0) {
        last_id = data[data.length - 1].id;
        setLogs(data);
      }
      return setTimeout((function() {
        return getLogs(last_id);
      }), 1000);
    });
  };

  getLogs();

  formatOutput = function(message) {
    return message.replace(/\n/g, '<br>').replace(/\s/g, '&nbsp;');
  };

  $('.line').each(function(i, element) {
    var e;
    e = $(element);
    return e.html(formatOutput(e.html()));
  });

}).call(this);
